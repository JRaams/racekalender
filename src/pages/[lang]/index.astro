---
import { Icon } from 'astro-icon/components';
import TimeDistance from '~/components/TimeDistance.svelte';
import { languages, type Language } from '~/i18n/ui';
import { useTranslations } from '~/i18n/utils';
import Layout from '~/layouts/Layout.astro';
import { TypeToIconMap, TypeToNameMap } from '~/types/eventtype';
import { CreateGroupedRaceRows } from '~/utils/racegrouper';
import dayjs from 'dayjs';
import 'dayjs/locale/nl';
import relativeTime from 'dayjs/plugin/relativeTime';
import dayOfYear from 'dayjs/plugin/dayOfYear';

const params = Astro.params;
const lang = params.lang as Language;

dayjs.extend(relativeTime);
dayjs.extend(dayOfYear);
dayjs.locale(lang);

const t = useTranslations(lang);
const raceWeeks = CreateGroupedRaceRows(lang);

export function getStaticPaths() {
  return Object.keys(languages).map((x) => ({ params: { lang: x } }));
}
---

<script>
  import dayjs from 'dayjs';

  import dayOfYear from 'dayjs/plugin/dayOfYear';
  import isoWeek from 'dayjs/plugin/isoWeek';
  dayjs.extend(isoWeek);
  dayjs.extend(dayOfYear);

  window.addEventListener('DOMContentLoaded', () => {
    let nextWeekNumber: number | undefined;
    let nextDayNumber: number | undefined;
    const now = new Date();

    document.querySelectorAll('.week').forEach(($week) => {
      const timestamp = Number($week.getAttribute('data-timestamp'));
      const date = dayjs(timestamp);

      if (date.isBefore(now, 'days')) {
        $week.classList.add('past');

        const $weekNumber = $week.querySelector('.week-number');
        $weekNumber?.classList.add('strikethrough');
        return;
      } else {
        $week.setAttribute('open', '');
      }

      const weekNumber = date.isoWeek();
      if (nextWeekNumber === undefined) {
        nextWeekNumber = weekNumber;
        $week.classList.add('current-week');

        window.scrollTo({
          top: $week.getBoundingClientRect().top + window.scrollY - 50,
          behavior: 'instant',
        });
      }
    });

    document.querySelectorAll('.day').forEach(($day) => {
      const timestamp = Number($day.getAttribute('data-timestamp'));
      const date = dayjs(timestamp);

      const weekNumber = date.isoWeek();
      if (nextWeekNumber === weekNumber) {
        $day.classList.add('current-week');
      }

      if (date.isBefore(now, 'days')) {
        $day.classList.add('past');
        $day.classList.add('strikethrough');
        return;
      }

      const dayNumber = date.dayOfYear();
      if (nextDayNumber === undefined) {
        nextDayNumber = dayNumber;
        $day.classList.add('current-day');
      }
    });
  });
</script>

<Layout title={t('nav.title')}>
  {
    Object.entries(raceWeeks).map(([weekNumber, week]) => (
      <details class="week" data-timestamp={week.lastRaceDate}>
        <summary>
          <strong class="week-number">Week {weekNumber}</strong>
        </summary>

        {Object.values(week.days).map((day) => (
          <>
            <div class="day" data-timestamp={day.timeStamp}>
              {dayjs(day.timeStamp).format('dddd DD MMMM')}
            </div>

            {day.races.map((race) => (
              <div class="race" data-timestamp={race.date}>
                <div>
                  <strong class="title">
                    {/* TODO: astro island? */}
                    <TimeDistance client:only="svelte" timestamp={race.date} lang={lang} />
                    {race.kind}
                    <Icon name={TypeToIconMap[race.type]} size={16} />
                    {TypeToNameMap[race.type]}
                  </strong>

                  <span class="name">{race.name}</span>
                </div>

                <div class="circuit">
                  <div>
                    <span class="no-wrap">{race.circuit.name}</span>

                    <small>
                      {race.circuit.city}, {t(('country.' + race.circuit.countryCode) as any)}
                    </small>
                  </div>

                  <Icon class="country-flag" name={'flagpack:' + race.circuit.countryCode.toLowerCase()} size={24} />
                </div>
              </div>
            ))}
          </>
        ))}
      </details>
    ))
  }
</Layout>

<style>
  .week {
    border-left: 10px solid var(--pico-code-background-color);
    border-right: 1px solid var(--pico-code-background-color);

    summary {
      background: var(--pico-code-background-color);
      padding: 1em;
      margin-bottom: 0;
    }
  }
  .current-week {
    border-left-color: var(--pico-primary-background);

    summary {
      background: var(--pico-primary-background);

      .week-number {
        color: white;
      }
    }
  }

  .day {
    font-size: 0.9em;
    padding: 1em;
    border-bottom: 1px solid var(--pico-code-background-color);
    background-color: rgb(from var(--pico-code-background-color) r g b / 50%);
  }

  .race {
    display: flex;
    flex-direction: column;
    gap: 1em;
    font-size: 0.8em;
    padding: 1em;
    border-bottom: 1px solid var(--pico-code-background-color);

    .title {
      display: flex;
      gap: 0.5em;
      align-items: center;
    }
  }

  .circuit {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 1em;
    text-align: right;

    > div {
      display: flex;
      flex-direction: column;
    }
  }

  @media screen and (width >= 768px) {
    .race {
      flex-direction: row;
      justify-content: space-between;

      > div {
        margin-left: 1em;
      }
    }

    .country-flag {
      width: 32px;
      height: 32px;
    }
  }

  @media screen and (width >= 1024px) {
    .country-flag {
      width: 48px;
      height: 48px;
    }
  }
</style>
